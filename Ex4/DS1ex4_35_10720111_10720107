// 10720111 陳少暉 10720107 陳丕中

#include<iostream>
#include<cstdio>
#include<vector>
#include<string>
#include<ctime>

using namespace std ;

struct Job {

    // 每個工作所帶有的資料
    int ID ;
    int arrival ;
    int duration ;
    int timeout ;

};

class sortQueue {

    struct QueueNode {
		int num ;
		QueueNode * next ;
	};

	QueueNode * backPtr ;
	QueueNode * frontPtr ;

	public :

	Queue() ;
	bool IsEmpty() ;
	void EnQueue( int newNum ) ;
	void DeQueue() ;
	void DeQueue( int getNum ) ;
	void GetFront( int getNum ) ;


};

bool sortQueue::IsEmpty() {

	if ( frontPtr == NULL )
	    return true ;
	else if ( backPtr == NULL )
	    return true ;
    else
        return false ;
} // isEmpty()

void sortQueue::EnQueue ( int newNum ) { // enQueue() 新增
   // 將東西放入queue
	QueueNode * newPtr = new QueueNode ;
	newPtr->num = newNum ;
	newPtr->next = NULL ;

	if ( IsEmpty() )
	    frontPtr = newPtr ;
	else
	    backPtr->next = newPtr ;

    backPtr = newPtr ;
} // enQueue()

void sortQueue::DeQueue () { // deQueue 移除
    // 將東西拿出queue

	if ( IsEmpty() ) {
		printf( "is Empty!") ;
	} // if
	else {

	    QueueNode * tempPtr = frontPtr ;
	    if ( frontPtr == backPtr ) {
	    	frontPtr = NULL ;
	    	backPtr = NULL ;
	    } // if
	    else {
	    	frontPtr = frontPtr->next ;
	    } // else

	    tempPtr->next = NULL ;
    	delete tempPtr ;
    } // else
} //deQueue()

void sortQueue::GetFront ( int getNum ) { // getFront() 擷取
    // 看queue最前面是什麼

	if ( IsEmpty() )
	    printf("is Empty!!") ;

    else
        getNum = frontPtr->num ;
} // getFront()

void sortQueue::DeQueue( int getNum ) { // deQueue() 擷取後刪除
    if( IsEmpty() ) {
    	printf("is Empty!") ;
	} // if
	else {
		getNum = frontPtr->num ;
		DeQueue() ;
	} // else

} // 擷取後刪除



class JobList {
    // 存放工作的清單

    vector<Job> aList ;


    public:

    void Sort( clock_t &t ) ;
    bool Load( string fileName, clock_t &t ) ;
    bool Load( string fileName ) ;
    void PrintAll() ;
    bool Export( string fileName, clock_t &t ) ;

}; // class JobList


bool JobList::Export( string fileName, clock_t &t ) {
    // Export sorted job list to .txt

    t = clock() ;
    FILE *outFile = NULL ;
    bool success = false ;
    fileName = "sorted" + fileName + ".txt" ;
    outFile = fopen( fileName.c_str(), "w" ) ;
    if ( outFile == NULL )
        ;
    else {

        fprintf( outFile, "OID\tArrival\tDuration\tTimeOut\n" ) ;
        for ( int i = 0 ; i < aList.size() ; i++ ) {
            fprintf( outFile, "%d\t%d\t%d\t%d\n", aList.at( i ).ID, aList.at( i ).arrival
                    , aList.at( i ).duration, aList.at( i ).timeout ) ;
        } // for

        success = true ;
        fclose( outFile ) ;

    } // else

    t = clock() - t ;
    return success ;

} // Export

void JobList::PrintAll(){

    cout << "OID\tArrival\tDuration\tTimeOut\n" ;
    for ( int i = 0 ; i < aList.size() ; i++ ) {
        cout << aList.at(i).ID << "\t" << aList.at(i).arrival << "\t" ;
        cout << aList.at(i).duration << "\t" << aList.at(i).timeout << "\n" ;
    } // for
    cout << "\n" ;

} // PrintAll

void JobList::Sort( clock_t &t ){
    // 用shell sort將其變為從小到大排序
    t = clock() ;
    for ( int gap = aList.size()/2 ; gap > 0 ; gap = gap / 2 )
        for ( int i = gap ; i < aList.size() ; i++ ) {
            Job tempJob = aList.at( i ) ;
            int j = -1 ;
            for ( j = i ; j >= gap && ( tempJob.arrival < aList.at( j - gap ).arrival
                || ( tempJob.arrival == aList.at( j - gap ).arrival
                    && tempJob.ID < aList.at( j - gap ).ID ) ) ; j = j - gap ) {
                aList.at( j ) = aList.at( j -  gap ) ;
            } // for

            aList.at(j) = tempJob ;
        } // for
    t = clock() - t ;

} // Sort

bool JobList::Load( string fileName, clock_t &t ) {
    // 讀檔
    FILE *infile = NULL ;
    bool success = false ;
    t = clock() ;

    fileName = "input" + fileName + ".txt" ;
    infile = fopen(fileName.c_str(), "r" ) ;

	if ( infile == NULL )
		;
	else{

        char temp ;

        while ( fscanf( infile, "%c", &temp ) != EOF && temp != '\n' )
            ;

        Job aJob ;
        while ( fscanf( infile, "%d %d %d %d", &aJob.ID, &aJob.arrival, &aJob.duration, &aJob.timeout ) != EOF )
            aList.push_back( aJob ) ;

        success = true ;
        fclose( infile ) ;

	} // else

    t = clock() - t ;

	return success ;

} // Load

bool JobList::Load( string fileName ) {
    // 讀檔
    FILE *infile = NULL ;
    bool success = false ;

    fileName = "sorted" + fileName + ".txt" ;
    infile = fopen(fileName.c_str(), "r" ) ;

	if ( infile == NULL )
		;
	else{

        char temp ;

        while ( fscanf( infile, "%c", &temp ) != EOF && temp != '\n' )
            ;

        Job aJob ;
        while ( fscanf( infile, "%d %d %d %d", &aJob.ID, &aJob.arrival, &aJob.duration, &aJob.timeout ) != EOF )
            aList.push_back( aJob ) ;

        success = true ;
        fclose( infile ) ;

	} // else

	return success ;

} // Load

int main(){

    cout << "(0)Exit\n(1)Sort file\n(2)Simulate(not yet)\n" ;
    cout << "Command: " ;
    int cmd = -1 ;
    cin >> cmd ;
    while ( cmd != 0 ) {
        if ( cmd == 1 ) {

            JobList aList ;
            string fileName ;
            cout << "file name:" ;
            cin >> fileName ;
            clock_t tLoad, tSort, tExport ;
            if ( !aList.Load( fileName, tLoad ) )
                cout << "Can not find the file.\n" ;
            else {
                aList.PrintAll() ;
                aList.Sort( tSort ) ;
                aList.Export( fileName, tExport ) ;
                float msLoad = (float)tLoad / CLOCKS_PER_SEC * 1000 ,
                      msSort = (float)tSort / CLOCKS_PER_SEC * 1000 ,
                      msExport = (float)tExport / CLOCKS_PER_SEC * 1000  ;

                printf( "Reading data: %d clocks (%.2f ms).\n", tLoad, msLoad ) ;
                printf( "Sorting data: %d clocks (%.2f ms).\n", tSort, msSort ) ;
                printf( "Writing data: %d clocks (%.2f ms).\n", tExport, msExport ) ;

                cout << "\nSee sorted" << fileName << ".txt for detail.\n" ;
            } // else

        } // if
        else if( cmd == 2 ) {

            JobList aList ;
            string fileName ;
            cout << "file name:" ;
            cin >> fileName ;
            aList.Load( fileName ) ;

        } // else if cmd == 2

        cout << "(0)Exit\n(1)Sort file\n(2)Simulate(not yet)\n" ;
        cout << "Command: " ;
        cin >> cmd ;

    } // while

    return 0 ;

} // main()
